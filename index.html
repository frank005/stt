<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RTT Start</title>

  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- jQuery (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

  <!-- Agora SDK -->
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>

  <!-- Protobuf (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/protobufjs/6.11.3/protobuf.min.js"></script>

  <!-- Update Protobuf references -->
  <script src="proto/protobuf.min.js"></script>
  <script src="proto/index.js"></script>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="css/styles.css">
</head>

<body class="bg-gray-900 text-white min-h-screen p-8">
  <!-- Add popup section at the top of body -->
  <div id="popup-section" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50"></div>

  <div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-2xl font-bold">Agora Real-Time Transcription & Translation Demo</h1>
      
      <div class="flex gap-3 items-center">
        <button 
          onclick="document.getElementById('connectionModal').showModal()"
          class="bg-blue-600 hover:bg-blue-700 px-4 py-1.5 rounded-lg font-semibold text-sm"
        >
          Connection Settings
        </button>
        
        <button 
          onclick="handleVersionChange();document.getElementById('sttModal').showModal();document.getElementById('request-preview').classList.add('hidden');"
          class="bg-green-600 hover:bg-green-700 px-4 py-1.5 rounded-lg font-semibold text-sm"
        >
          STT Settings
        </button>

        <a href="https://github.com/AgoraIO-Community/stt" 
           target="_blank" 
           class="text-gray-300 hover:text-white transition-colors"
           title="View on GitHub">
          <svg height="32" viewBox="0 0 16 16" width="32" class="fill-current">
            <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
          </svg>
        </a>
      </div>
    </div>

    <!-- Update local video template -->
    <div class="video-wrapper">
      <div class="language-selector">
        <select id="translation-lang-local" 
                class="bg-gray-800 rounded px-2 py-1 text-sm" 
                onchange="updateTranslationView('local')">
        </select>
        </div>
      <div class="video-container">
        <div id="local-player" class="w-full h-full"></div>
        <div class="transcriptioncaps-overlay">
          <div id="transcriptioncaps-local" class="text-xl mb-2"></div>
          <div id="translationcaps-local" class="text-gray-300"></div>
        </div>
        </div>
      </div>

    <!-- Remote videos -->
    <div id="remote-playerlist" class="remote-grid"></div>

    <!-- Control buttons -->
    <div class="flex gap-3 mt-6">
      <button id="join" class="bg-blue-600 hover:bg-blue-700 px-4 py-1.5 rounded-lg font-semibold text-sm">
          Join
        </button>
      <button id="leave" class="bg-red-600 hover:bg-red-700 px-4 py-1.5 rounded-lg font-semibold text-sm opacity-50 cursor-not-allowed" disabled>
          Leave
        </button>
      <button id="start-trans" class="bg-green-600 hover:bg-green-700 px-4 py-1.5 rounded-lg font-semibold text-sm opacity-50 cursor-not-allowed" disabled>
          Start RTT
        </button>
      <button id="stop-trans" class="bg-red-600 hover:bg-red-700 px-4 py-1.5 rounded-lg font-semibold text-sm opacity-50 cursor-not-allowed" disabled>
          Stop RTT
        </button>
    </div>

    <!-- Translation Control buttons (only visible when transcription is active) -->
    <div id="translation-controls" class="flex gap-3 mt-4 hidden">
      <div class="flex items-center gap-3">
        <span class="text-sm text-gray-300">Translation:</span>
        <span id="translation-status" class="text-sm font-medium text-gray-400">Disabled</span>
      </div>
      <button id="enable-translation" onclick="enableTranslationDuringSession()" class="bg-green-600 hover:bg-green-700 px-4 py-1.5 rounded-lg font-semibold text-sm">
        Enable
      </button>
      <button id="disable-translation" onclick="disableTranslationDuringSession()" class="bg-orange-600 hover:bg-orange-700 px-4 py-1.5 rounded-lg font-semibold text-sm">
        Disable
      </button>
      <button onclick="showTranslationConfigModal()" class="bg-blue-600 hover:bg-blue-700 px-4 py-1.5 rounded-lg font-semibold text-sm">
        Configure
      </button>
    </div>

    <!-- Connection Settings Modal -->
    <dialog id="connectionModal">
      <h2 class="text-xl font-bold mb-6">Connection Settings</h2>
      
      <div class="space-y-4">
        <div>
          <label class="block mb-2">App ID</label>
          <input id="appid" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter App ID">
          </div>
        
        <div>
          <label class="block mb-2">Channel Name</label>
          <input id="channel" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter channel name">
        </div>

        <div>
          <label class="block mb-2">User ID (optional)</label>
          <div class="flex items-center gap-2">
            <input id="uid" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter user ID">
            <label class="flex items-center text-xs gap-1 ml-2">
              <input id="uid-string" type="checkbox" class="mr-1 align-middle">
              Use string UID
            </label>
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-4 mt-6">
        <button
          onclick="this.closest('dialog').close()"
          class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded"
        >
          Cancel
        </button>
        <button 
          onclick="saveConnectionSettings()"
          class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded"
        >
          Save
        </button>
      </div>
    </dialog>

    <!-- STT Settings Modal -->
    <dialog id="sttModal">
      <h2 class="text-xl font-bold mb-8">STT Settings</h2>
      
      <!-- Inline alert for modal warnings -->
      <div id="stt-modal-alert" class="hidden bg-red-600 text-white px-4 py-2 rounded mb-4"></div>
      <div class="space-y-6">
        <!-- Version Selection -->
        <div>
          <label class="block mb-2">STT Version</label>
          <select id="stt-version" class="w-full bg-gray-800 rounded p-2" onchange="handleVersionChange()">
            <option value="6.x">6.x</option>
            <option value="7.x" selected>7.x</option>
          </select>
        </div>

        <!-- Authentication -->
        <div>
          <label class="block mb-2">Customer Key</label>
          <input id="key" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter customer key">
        </div>
        
        <div>
          <label class="block mb-2">Customer Secret</label>
          <input id="secret" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter customer secret">
      </div>

        <!-- Languages -->
        <div>
          <label class="block mb-2">Speaking Languages</label>
          <div id="speaking-languages" class="space-y-2">
            <div class="flex gap-2">
              <input type="text" class="flex-1 bg-gray-800 rounded p-2" value="en-US">
              <button onclick="addLanguageInput('speaking-languages')" class="bg-blue-600 px-3 rounded">+</button>
            </div>
          </div>
          <p class="text-gray-400 text-sm mt-1">Maximum <span id="max-speaking-languages">2</span> speaking languages allowed</p>
        </div>

        <!-- Max Idle Time -->
        <div>
          <label class="block mb-2">Max Idle Time (seconds)</label>
          <input id="max-idle-time" type="number" class="w-full bg-gray-800 rounded p-2" value="60" min="10" max="300">
          <p class="text-gray-400 text-sm mt-1">Maximum time (in seconds) the service will wait for audio before stopping</p>
        </div>

        <!-- Translation -->
        <div>
          <label class="block mb-2">Translation Settings</label>
          <p class="text-gray-400 mb-4">Note: To enable translation, specify at least one source language and its target language(s).</p>
          
          <div id="translation-pairs" class="space-y-4">
            <div class="translation-pair border border-gray-700 p-4 rounded">
              <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                  <label class="block">Source Language</label>
                  <button onclick="this.closest('.translation-pair').remove(); saveTranslationSettings();" class="text-red-500 text-sm">Remove Pair</button>
        </div>
                <input type="text" class="source-lang w-full bg-gray-800 rounded p-2" placeholder="e.g., en-US">
              </div>
              <div class="target-languages space-y-2">
                <label class="block mb-2">Target Languages</label>
                <div class="flex gap-2">
                  <input type="text" class="flex-1 bg-gray-800 rounded p-2" placeholder="Target language (e.g., es-ES)">
                  <button onclick="addTargetLanguage(this)" class="bg-blue-600 px-3 rounded">+</button>
                </div>
              </div>
            </div>
          </div>
          <button onclick="addTranslationPair()" class="mt-4 bg-blue-600 px-4 py-2 rounded">Add Translation Pair</button>
      </div>

        <!-- Bot Configuration -->
        <div class="border-t border-gray-700 pt-4">
          <h3 class="font-semibold mb-4">Bot Configuration</h3>
          <div class="settings-grid">
        <div>
              <label class="block mb-2">Sub Bot UID</label>
              <input id="puller-uid" type="text" class="w-full bg-gray-800 rounded p-2" value="666">
              <p class="text-gray-400 text-xs mt-1" id="sub-bot-note">Not used in 7.x version</p>
        </div>
        <div>
              <label class="block mb-2">Sub Bot Token (Optional)</label>
              <input id="puller-token" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter sub bot token">
              <p class="text-gray-400 text-xs mt-1" id="sub-bot-token-note">Not used in 7.x version</p>
        </div>
            <div>
              <label class="block mb-2">Pub Bot UID</label>
              <input id="pusher-uid" type="text" class="w-full bg-gray-800 rounded p-2" value="66666">
      </div>
        <div>
              <label class="block mb-2">Pub Bot Token (Optional)</label>
              <input id="pusher-token" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter pub bot token">
        </div>
          </div>
        </div>

        <!-- Encryption Settings -->
        <div class="border-t border-gray-700 pt-4">
          <h3 class="font-semibold mb-4">Encryption Settings</h3>
          <div class="settings-grid">
        <div>
              <label class="block mb-2">Decryption Mode</label>
              <input id="decryption-mode" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter mode (optional)">
        </div>
        <div>
              <label class="block mb-2">Secret</label>
              <input id="encryption-secret" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter secret (optional)">
        </div>
        <div>
              <label class="block mb-2">Salt</label>
              <input id="encryption-salt" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter salt (optional)">
            </div>
        </div>
      </div>

        <!-- Storage Configuration -->
        <div class="border-t border-gray-700 pt-4">
          <h3 class="font-semibold mb-4">Storage Configuration</h3>
          <div class="settings-grid">
        <div>
              <label class="block mb-2">S3 Access Key</label>
              <input id="s3-access-key" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter access key">
        </div>
        <div>
              <label class="block mb-2">S3 Secret Key</label>
              <input id="s3-secret-key" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter secret key">
        </div>
            <div>
              <label class="block mb-2">S3 Bucket</label>
              <input id="s3-bucket" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter bucket name">
      </div>
            <div>
              <label class="block mb-2">S3 Region</label>
              <input id="s3-region" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter region">
      </div>
            <div>
              <label class="block mb-2">S3 Vendor</label>
              <input id="s3-vendor" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter vendor">
    </div>
            <div>
              <label class="block mb-2">File Name Prefix</label>
              <input id="s3-fileNamePrefix" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter prefix">
        </div>
        </div>
      </div>

        <!-- Request Preview -->
        <div class="border-t border-gray-700 pt-4">
          <h3 class="font-semibold mb-4">Request Preview</h3>
          <p class="text-gray-400 mb-4">Preview the request body that will be sent to start transcription:</p>
          <button 
            onclick="previewStartRequest()"
            class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded mb-4"
          >
            Preview Request
          </button>
          <div id="request-preview" class="hidden">
            <div class="flex justify-between items-center mb-2">
              <label class="block">Request Body (JSON)</label>
              <button 
                onclick="copyRequestToClipboard()"
                class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-sm"
              >
                Copy
              </button>
            </div>
            <pre id="request-body" class="bg-gray-800 p-4 rounded text-sm overflow-x-auto whitespace-pre-wrap"></pre>
          </div>
        </div>
    </div>

      <div class="flex justify-end gap-4 mt-8">
        <button 
          onclick="this.closest('dialog').close()"
          class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded"
        >
          Cancel
        </button>
        <button 
          onclick="saveSTTSettings()"
          class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded"
        >
          Save
        </button>
      </div>
    </dialog>

    <!-- Translation Configuration Modal -->
    <dialog id="translationConfigModal">
      <h2 class="text-xl font-bold mb-6">Configure Translation Languages</h2>
      
      <div class="space-y-4">
        <p class="text-gray-400 mb-4">Configure translation language pairs for the current session:</p>
        
        <div id="session-translation-pairs" class="space-y-4">
          <div class="translation-pair border border-gray-700 p-4 rounded">
            <div class="mb-4">
              <div class="flex justify-between items-center mb-2">
                <label class="block">Source Language</label>
                <button onclick="this.closest('.translation-pair').remove();" class="text-red-500 text-sm">Remove Pair</button>
              </div>
              <input type="text" class="source-lang w-full bg-gray-800 rounded p-2" placeholder="e.g., en-US">
            </div>
            <div class="target-languages space-y-2">
              <label class="block mb-2">Target Languages</label>
              <div class="flex gap-2">
                <input type="text" class="flex-1 bg-gray-800 rounded p-2" placeholder="Target language (e.g., es-ES)">
                <button onclick="addTargetLanguage(this)" class="bg-blue-600 px-3 rounded">+</button>
              </div>
            </div>
          </div>
        </div>
        
        <button onclick="addSessionTranslationPair()" class="mt-4 bg-blue-600 px-4 py-2 rounded">Add Translation Pair</button>
      </div>

      <div class="flex justify-end gap-4 mt-8">
        <button 
          onclick="this.closest('dialog').close()"
          class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded"
        >
          Cancel
        </button>
        <button 
          onclick="updateTranslationLanguagesDuringSession()"
          class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded"
        >
          Update/Enable Languages
        </button>
      </div>
    </dialog>
  </div>

  <!-- JavaScript modules -->
  <script src="js/config.js"></script>
  <script src="js/agora-client.js"></script>
  <script src="js/transcription.js"></script>
  <script src="js/translation.js"></script>
  <script src="js/ui.js"></script>
  <script src="js/settings.js"></script>
  <script src="js/main.js"></script>

</body>
</html>
