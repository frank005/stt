<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RTT Start</title>

  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- jQuery (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

  <!-- Agora SDK -->
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>

  <!-- Protobuf (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/protobufjs/6.11.3/protobuf.min.js"></script>

  <!-- Update Protobuf references -->
  <script src="proto/protobuf.min.js"></script>
  <script src="proto/index.js"></script>

  <style>
    /* Modal styles */
    dialog {
      background: #1f2937;
      color: white;
      padding: 2.5rem;
      border-radius: 1rem;
      border: 1px solid #374151;
      max-width: 90vw;
      width: 800px;
      margin: 2rem auto;
      overflow-y: auto;
      max-height: 90vh;
    }
    
    dialog::backdrop {
      background: rgba(0, 0, 0, 0.8);
    }

    dialog h2 {
      padding: 0 1rem;  /* Add padding to title */
    }

    /* Video container styles */
    .video-container {
      position: relative;
      aspect-ratio: 16/9;
      background: #000;
      border-radius: 0.5rem;
      overflow: hidden;
      width: 100%;
      max-width: 640px;
      margin: 0 auto 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .video-container video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }

    .transcription-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      padding: 1rem;
      color: white;
      z-index: 10;
      width: 100%;
      transition: opacity 0.3s ease;
    }

    .transcription-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    /* Remote video grid - limit to 4 columns */
    #remote-playerlist {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1rem;
      width: 100%;
    }

    @media (min-width: 1024px) {
      #remote-playerlist {
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        max-width: 100%;
      }
    }

    .remote-video {
      position: relative;
      aspect-ratio: 16/9;
      background: #000;
      border-radius: 0.5rem;
      overflow: hidden;
      width: 100%;
    }

    .remote-video video {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .remote-video .transcription-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      padding: 1rem;
      color: white;
      z-index: 10;
    }

    /* Popup styles */
    .popupHidden {
      display: none;
    }

    .popupShow {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: #2d2d2d;
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      animation: fadeInOut 0.3s ease-in-out;
      z-index: 10000;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translate(-50%, 20px); }
      100% { opacity: 1; transform: translate(-50%, 0); }
    }

    /* Input styles */
    input[type="text"] {
      width: 100%;
      padding: 0.75rem 1rem;
      background: #374151 !important;
      border: 1px solid #4B5563;
      color: white !important;
      border-radius: 0.5rem;
      margin-top: 0.5rem;
    }

    input[type="text"]::placeholder {
      color: #9CA3AF;
    }

    /* Modal section spacing */
    .space-y-6 {
      padding: 0 1rem;
    }

    .border-t {
      border-color: #4B5563;
      margin-top: 2rem;
      padding-top: 2rem;
    }

    /* Modal labels */
    label {
      font-size: 1rem;
      font-weight: 500;
      color: #E5E7EB;
    }

    /* Modal buttons */
    dialog button {
      min-width: 100px;
      padding: 0.75rem 1.5rem;
    }

    /* Update modal footer */
    dialog .flex.justify-end {
      margin: 2rem 0 0 0;  /* Remove negative margins */
      padding: 1.5rem;
      background: #161e2e;
      border-top: 1px solid #374151;
      width: 100%;
    }

    /* Content container inside dialog */
    dialog > div:not(.flex) {
      padding: 0 1rem;
      margin-bottom: 2rem;
    }

    .translation-pair {
      background: rgba(0, 0, 0, 0.2);
      margin-bottom: 1rem;
    }

    .translation-pair:last-child {
      margin-bottom: 0;
    }

    .target-languages {
      border-top: 1px solid rgba(75, 85, 99, 0.4);
      padding-top: 1rem;
      margin-top: 1rem;
    }

    /* Fix grid alignment for translation pairs */
    #translation-pairs {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    /* Remove number input spinners */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type="number"] {
      -moz-appearance: textfield;
    }

    /* Fix grid alignment */
    .settings-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-bottom: 1rem;
    }

    /* Remove any empty remote video containers */
    .remote-video:empty {
      display: none;
    }

    /* Update video container styles */
    .video-wrapper {
      margin-bottom: 1rem;
    }

    .language-selector {
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: flex-end;
    }

    /* Remove empty containers */
    .remote-video:empty,
    #remote-playerlist:empty,
    #remote-playerlist > div:empty,
    .video-wrapper:empty {
      display: none !important;
    }
  </style>
</head>

<body class="bg-gray-900 text-white min-h-screen p-8">
  <!-- Add popup section at the top of body -->
  <div id="popup-section" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50"></div>

  <div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-2xl font-bold">Real-Time Transcription</h1>
      
      <div class="flex gap-4 items-center">
        <button 
          onclick="document.getElementById('connectionModal').showModal()"
          class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-semibold"
        >
          Connection Settings
        </button>
        
        <button 
          onclick="handleVersionChange();document.getElementById('sttModal').showModal()"
          class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg font-semibold"
        >
          STT Settings
        </button>

        <a href="https://github.com/frank005/stt" 
           target="_blank" 
           class="text-gray-300 hover:text-white transition-colors"
           title="View on GitHub">
          <svg height="32" viewBox="0 0 16 16" width="32" class="fill-current">
            <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
          </svg>
        </a>
      </div>
    </div>

    <!-- Update local video template -->
    <div class="video-wrapper">
      <div class="language-selector">
        <select id="translation-lang-local" 
                class="bg-gray-800 rounded px-2 py-1 text-sm" 
                onchange="updateTranslationView('local')">
        </select>
        </div>
      <div class="video-container">
        <div id="local-player" class="w-full h-full"></div>
        <div class="transcription-overlay">
          <div id="transcription-local" class="text-xl mb-2"></div>
          <div id="translation-local" class="text-gray-300"></div>
        </div>
        </div>
      </div>

    <!-- Remote videos -->
    <div id="remote-playerlist" class="remote-grid"></div>

    <!-- Control buttons -->
    <div class="flex gap-4 mt-8">
      <button id="join" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-semibold">
          Join
        </button>
      <button id="leave" class="bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg font-semibold opacity-50 cursor-not-allowed" disabled>
          Leave
        </button>
      <button id="start-trans" class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg font-semibold opacity-50 cursor-not-allowed" disabled>
          Start RTT
        </button>
      <button id="stop-trans" class="bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg font-semibold opacity-50 cursor-not-allowed" disabled>
          Stop RTT
        </button>
    </div>

    <!-- Connection Settings Modal -->
    <dialog id="connectionModal">
      <h2 class="text-xl font-bold mb-6">Connection Settings</h2>
      
      <div class="space-y-4">
        <div>
          <label class="block mb-2">App ID</label>
          <input id="appid" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter App ID">
          </div>
        
        <div>
          <label class="block mb-2">Channel Name</label>
          <input id="channel" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter channel name">
        </div>

        <div>
          <label class="block mb-2">User ID (optional)</label>
          <input id="uid" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter user ID">
        </div>
      </div>

      <div class="flex justify-end gap-4 mt-6">
        <button
          onclick="this.closest('dialog').close()"
          class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded"
        >
          Cancel
        </button>
        <button 
          onclick="saveConnectionSettings()"
          class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded"
        >
          Save
        </button>
      </div>
    </dialog>

    <!-- STT Settings Modal -->
    <dialog id="sttModal">
      <h2 class="text-xl font-bold mb-8">STT Settings</h2>
      
      <!-- Inline alert for modal warnings -->
      <div id="stt-modal-alert" class="hidden bg-red-600 text-white px-4 py-2 rounded mb-4"></div>
      <div class="space-y-6">
        <!-- Version Selection -->
        <div>
          <label class="block mb-2">STT Version</label>
          <select id="stt-version" class="w-full bg-gray-800 rounded p-2" onchange="handleVersionChange()">
            <option value="6.x">6.x</option>
            <option value="7.x" selected>7.x</option>
          </select>
        </div>

        <!-- Authentication -->
        <div>
          <label class="block mb-2">Customer Key</label>
          <input id="key" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter customer key">
        </div>
        
        <div>
          <label class="block mb-2">Customer Secret</label>
          <input id="secret" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter customer secret">
      </div>

        <!-- Languages -->
        <div>
          <label class="block mb-2">Speaking Languages</label>
          <div id="speaking-languages" class="space-y-2">
            <div class="flex gap-2">
              <input type="text" class="flex-1 bg-gray-800 rounded p-2" value="en-US">
              <button onclick="addLanguageInput('speaking-languages')" class="bg-blue-600 px-3 rounded">+</button>
            </div>
          </div>
          <p class="text-gray-400 text-sm mt-1">Maximum <span id="max-speaking-languages">2</span> speaking languages allowed</p>
        </div>

        <!-- Translation -->
        <div>
          <label class="block mb-2">Translation Settings</label>
          <p class="text-gray-400 mb-4">Note: To enable translation, specify at least one source language and its target language(s).</p>
          
          <div id="translation-pairs" class="space-y-4">
            <div class="translation-pair border border-gray-700 p-4 rounded">
              <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                  <label class="block">Source Language</label>
                  <button onclick="this.closest('.translation-pair').remove(); saveTranslationSettings();" class="text-red-500 text-sm">Remove Pair</button>
        </div>
                <input type="text" class="source-lang w-full bg-gray-800 rounded p-2" placeholder="e.g., en-US">
              </div>
              <div class="target-languages space-y-2">
                <label class="block mb-2">Target Languages</label>
                <div class="flex gap-2">
                  <input type="text" class="flex-1 bg-gray-800 rounded p-2" placeholder="Target language (e.g., es-ES)">
                  <button onclick="addTargetLanguage(this)" class="bg-blue-600 px-3 rounded">+</button>
                </div>
              </div>
            </div>
          </div>
          <button onclick="addTranslationPair()" class="mt-4 bg-blue-600 px-4 py-2 rounded">Add Translation Pair</button>
      </div>

        <!-- Bot Configuration -->
        <div class="border-t border-gray-700 pt-4">
          <h3 class="font-semibold mb-4">Bot Configuration</h3>
          <div class="settings-grid">
        <div>
              <label class="block mb-2">Pull Bot UID</label>
              <input id="puller-uid" type="text" class="w-full bg-gray-800 rounded p-2" value="666">
        </div>
        <div>
              <label class="block mb-2">Pull Bot Token (Optional)</label>
              <input id="puller-token" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter pull bot token">
        </div>
            <div>
              <label class="block mb-2">Push Bot UID</label>
              <input id="pusher-uid" type="text" class="w-full bg-gray-800 rounded p-2" value="66666">
      </div>
        <div>
              <label class="block mb-2">Push Bot Token (Optional)</label>
              <input id="pusher-token" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter push bot token">
        </div>
          </div>
        </div>

        <!-- Encryption Settings -->
        <div class="border-t border-gray-700 pt-4">
          <h3 class="font-semibold mb-4">Encryption Settings</h3>
          <div class="settings-grid">
        <div>
              <label class="block mb-2">Decryption Mode</label>
              <input id="decryption-mode" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter mode (optional)">
        </div>
        <div>
              <label class="block mb-2">Secret</label>
              <input id="encryption-secret" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter secret (optional)">
        </div>
        <div>
              <label class="block mb-2">Salt</label>
              <input id="encryption-salt" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter salt (optional)">
            </div>
        </div>
      </div>

        <!-- Storage Configuration -->
        <div class="border-t border-gray-700 pt-4">
          <h3 class="font-semibold mb-4">Storage Configuration</h3>
          <div class="settings-grid">
        <div>
              <label class="block mb-2">S3 Access Key</label>
              <input id="s3-access-key" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter access key">
        </div>
        <div>
              <label class="block mb-2">S3 Secret Key</label>
              <input id="s3-secret-key" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter secret key">
        </div>
            <div>
              <label class="block mb-2">S3 Bucket</label>
              <input id="s3-bucket" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter bucket name">
      </div>
            <div>
              <label class="block mb-2">S3 Region</label>
              <input id="s3-region" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter region">
      </div>
            <div>
              <label class="block mb-2">S3 Vendor</label>
              <input id="s3-vendor" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter vendor">
    </div>
            <div>
              <label class="block mb-2">File Name Prefix</label>
              <input id="s3-fileNamePrefix" type="text" class="w-full bg-gray-800 rounded p-2" placeholder="Enter prefix">
        </div>
        </div>
      </div>
    </div>

      <div class="flex justify-end gap-4 mt-8">
        <button 
          onclick="this.closest('dialog').close()"
          class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded"
        >
          Cancel
        </button>
        <button 
          onclick="saveSTTSettings()"
          class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded"
        >
          Save
        </button>
      </div>
    </dialog>
  </div>

<script>
// Initialize variables
var client;
var options = {
  appid: null,
  channel: null,
  uid: null,
  token: null
};

let transcribeIndex = 0;
let translateIndex = 0;
let localTrack = null;
var localAudioTrack = null;

// Add these variables
let taskId = '';
let tokenName = '';
const gatewayAddress = "https://api.agora.io";
let sttVersion = "7.x"; // Default to 7.x

// Keep track of available languages for each user
const userLanguages = new Map(); // uid -> { speaking: string, translations: Set<string> }

// Add timeout tracking variables
const overlayTimeouts = new Map(); // uid -> timeout
const OVERLAY_HIDE_DELAY = 5000; // 5 seconds

// Initialize AgoraRTC client
if (!client) {
  client = AgoraRTC.createClient({
    mode: "live",
    codec: "vp8",
    role: "host"
  });
}

// Load saved settings on page load
$(document).ready(function() {
  updateButtonStates('initial');
  loadSavedSettings();
});

function loadSavedSettings() {
  // Load connection settings
  const savedConnection = JSON.parse(localStorage.getItem('connectionSettings') || '{}');
  if (savedConnection.appid) {
    $("#appid").val(savedConnection.appid);
    options.appid = savedConnection.appid;
  }
  if (savedConnection.channel) {
    $("#channel").val(savedConnection.channel);
    options.channel = savedConnection.channel;
  }

  // Load STT settings
  const savedSTT = JSON.parse(localStorage.getItem('sttSettings') || '{}');
  if (savedSTT.key) $("#key").val(savedSTT.key);
  if (savedSTT.secret) $("#secret").val(savedSTT.secret);
  if (savedSTT.version) {
    $("#stt-version").val(savedSTT.version);
    sttVersion = savedSTT.version;
  }
  if (savedSTT.speakingLanguage) $("#speaking-language").val(savedSTT.speakingLanguage);
  if (savedSTT.translationLanguage) $("#translation-language").val(savedSTT.translationLanguage);
}

// Save settings functions
function saveConnectionSettings() {
  options.appid = $("#appid").val();
    options.channel = $("#channel").val();
  options.uid = $("#uid").val();
  
  // Save to localStorage
  localStorage.setItem('connectionSettings', JSON.stringify({
    appid: options.appid,
    channel: options.channel
  }));
  
  document.getElementById('connectionModal').close();
  showPopup("Connection settings saved");
}

function saveSTTSettings() {
  const speakingLanguages = Array.from(document.querySelectorAll('#speaking-languages input'))
    .map(input => input.value)
    .filter(value => value.trim() !== '');

  localStorage.setItem('sttSettings', JSON.stringify({
    key: $("#key").val(),
    secret: $("#secret").val(),
    speakingLanguages: speakingLanguages,
    version: $("#stt-version").val()
  }));
  
  document.getElementById('sttModal').close();
  showPopup("STT settings saved");
}

// Get authorization
function GetAuthorization() {
  const customerKey = $("#key").val();
  const customerSecret = $("#secret").val();
  if (!customerKey || !customerSecret) {
    showPopup("Please configure STT settings first");
    return "";
  }
  return `Basic ${btoa(`${customerKey}:${customerSecret}`)}`;
}

// Acquire token
async function acquireToken() {
  if (sttVersion === "7.x") {
    // For 7.x, we don't need to acquire token separately
    return { tokenName: null };
  }

  const url = `${gatewayAddress}/v1/projects/${options.appid}/rtsc/speech-to-text/builderTokens`;
  const data = { instanceId: options.channel };
  let res = await fetch(url, {
    method: 'POST',
    headers: {
      "Content-Type": "application/json",
      "Authorization": GetAuthorization()
    },
    body: JSON.stringify(data)
  });
  if (res.status == 200) {
    res = await res.json();
    return res;
  } else {
    throw new Error(`Failed to acquire token: ${res.status}`);
  }
}

// Update the subscribe function to include transcription overlay
async function subscribe(user, mediaType) {
  const uid = user.uid;
  await client.subscribe(user, mediaType);
  console.log(`[${new Date().toLocaleTimeString()}] Subscribed to ${uid} for ${mediaType}`);
  
  if (mediaType === "video") {
    // Remove any existing container for this user first
    $(`#video-wrapper-${uid}`).remove();
    
    const player = $(`
      <div id="video-wrapper-${uid}" class="video-wrapper">
        <div class="language-selector">
          <select id="translation-lang-${uid}" 
                  class="bg-gray-800 rounded px-2 py-1 text-sm" 
                  onchange="updateTranslationView('${uid}')">
          </select>
        </div>
        <div class="video-container">
          <div id="player-${uid}" class="w-full h-full"></div>
          <div class="transcription-overlay">
            <div id="transcription-${uid}" class="text-xl mb-2"></div>
            <div id="translation-${uid}" class="text-gray-300"></div>
          </div>
        </div>
      </div>
    `);
    $("#remote-playerlist").append(player);
    user.videoTrack.play(`player-${uid}`);
    updateLanguageSelector(uid);
  }
  if (mediaType === "audio") {
    user.audioTrack.play();
  }
}

// Update stream message handler
client.on("stream-message", function(uid, data) {
  try {
    const Text = $protobufRoot.lookup("agora.audio2text.Text");
    const msg = Text.decode(data);
    
    // Show overlay whenever a message is received
    showOverlay(msg.uid);
    
    // Get current timestamp
    const timestamp = new Date().toLocaleTimeString();
    
    if (msg.data_type === "transcribe" && msg.words && msg.words.length) {
      const text = msg.words.map(word => word.text).join("");
      $(`#video-wrapper-${msg.uid} #transcription-${msg.uid}`).text(text);
      console.log(`[${timestamp}] Transcription from ${msg.uid}: ${text}`);
      addTranscribeItem(msg.uid, text);
    } 
    else if (msg.data_type === "translate" && msg.trans && msg.trans.length) {
      const selectedLang = $(`#translation-lang-${msg.uid}`).val();
      const translation = msg.trans.find(t => t.lang === selectedLang);
      if (translation) {
        const text = translation.texts.join("");
        $(`#video-wrapper-${msg.uid} #translation-${msg.uid}`).text(text);
        console.log(`[${timestamp}] Translation (${selectedLang}) from ${msg.uid}: ${text}`);
        addTranslateItem(msg.uid, text);
      }
    }
  } catch (error) {
    console.error("Error handling stream message:", error);
  }
});

// Update remote video handling
client.on("user-published", async function(user, mediaType) {
  await client.subscribe(user, mediaType);
  
  if (mediaType === "video") {
    // Check if container already exists and remove any duplicates
    const existingContainers = $(`[id^="video-wrapper-${user.uid}"]`);
    if (existingContainers.length) {
      // Keep only the first container and remove others
      existingContainers.slice(1).remove();
      // If first container already has video playing, just return
      if ($(`#player-${user.uid} video`).length) {
        return;
      }
    }

    // Remove any orphaned player divs
    $(`#player-${user.uid}`).not(`#video-wrapper-${user.uid} #player-${user.uid}`).remove();

    const playerContainer = $(`
      <div id="video-wrapper-${user.uid}" class="video-wrapper">
        <div class="language-selector">
          <select id="translation-lang-${user.uid}" 
                  class="bg-gray-800 rounded px-2 py-1 text-sm" 
                  onchange="updateTranslationView('${user.uid}')">
          </select>
        </div>
        <div class="remote-video">
          <div id="player-${user.uid}" class="w-full h-full"></div>
          <div class="transcription-overlay">
            <div id="transcription-${user.uid}" class="text-xl mb-2"></div>
            <div id="translation-${user.uid}" class="text-gray-300"></div>
          </div>
        </div>
      </div>
    `);

    // Only append if container doesn't exist
    if (!$(`#video-wrapper-${user.uid}`).length) {
      $("#remote-playerlist").append(playerContainer);
    }
    
    user.videoTrack.play(`player-${user.uid}`);
    updateLanguageSelector(user.uid);
  }
  
  if (mediaType === "audio") {
    user.audioTrack.play();
  }
});

// Update language selector to show all configured target languages
function updateLanguageSelector(uid) {
  const selector = $(`#translation-lang-${uid}`);
  const currentSelection = selector.val();
  
  // Get all configured target languages from settings
  const allTargetLanguages = translationSettings.pairs.reduce((acc, pair) => {
    pair.targets.forEach(target => {
      acc.push({ source: pair.source, target: target });
    });
    return acc;
  }, []);

  selector.empty();
  allTargetLanguages.forEach(({ source, target }) => {
    const option = $(`<option value="${target}">${source} → ${target}</option>`);
    selector.append(option);
  });

  // Restore previous selection or select first option
  if (currentSelection && selector.find(`option[value="${currentSelection}"]`).length) {
    selector.val(currentSelection);
  } else {
    selector.find('option:first').prop('selected', true);
  }

  // Log current selection for debugging
  console.log(`Language selector for ${uid} set to:`, selector.val());
}

// Update startTranscription to handle multiple languages
async function startTranscription() {
  const authorization = GetAuthorization();
  if (!authorization) {
    throw new Error("key or secret is empty");
  }

  const data = await acquireToken();
  tokenName = data.tokenName;

  // Build request body based on version
  const body = {
    languages: Array.from(document.querySelectorAll('#speaking-languages input'))
      .map(input => input.value)
      .filter(value => value.trim() !== ''),
    maxIdleTime: 50,
    rtcConfig: {
      channelName: options.channel,
      subBotUid: $("#puller-uid").val(),
      pubBotUid: $("#pusher-uid").val()
    }
  };

  // Add name field for 7.x
  if (sttVersion === "7.x") {
    body.name = options.channel; // Using channel name as the agent name
  }

  // Add optional tokens
  const pullToken = $("#puller-token").val();
  const pushToken = $("#pusher-token").val();
  if (pullToken) body.rtcConfig.subBotToken = pullToken;
  if (pushToken) body.rtcConfig.pubBotToken = pushToken;

  // Add encryption if specified
  const decryptionMode = $("#decryption-mode").val();
  const secret = $("#encryption-secret").val();
  const salt = $("#encryption-salt").val();
  if (decryptionMode) body.rtcConfig.cryptionMode = parseInt(decryptionMode);
  if (secret) body.rtcConfig.secret = secret;
  if (salt) body.rtcConfig.salt = salt;

  // Add translation config
  const translationPairs = Array.from(document.querySelectorAll('.translation-pair')).map(pair => {
    const source = pair.querySelector('.source-lang').value;
    const targets = Array.from(pair.querySelectorAll('.target-languages input')).map(input => input.value);
    return {
      source,
      target: targets
    };
  }).filter(pair => pair.source && pair.target.length > 0);

  if (translationPairs.length > 0) {
    body.translateConfig = {
      forceTranslateInterval: 5,
      languages: translationPairs
    };
  }

  // Add optional storage config
  const s3Bucket = $("#s3-bucket").val();
  if (s3Bucket) {
    body.captionConfig = {
      sliceDuration: 60,
      storage: {
        bucket: s3Bucket
      }
    };

    // Add optional storage credentials
    const s3AccessKey = $("#s3-access-key").val();
    const s3SecretKey = $("#s3-secret-key").val();
    if (s3AccessKey && s3SecretKey) {
      body.captionConfig.storage.accessKey = s3AccessKey;
      body.captionConfig.storage.secretKey = s3SecretKey;
    }

    // Add optional storage configuration
    const s3Vendor = $("#s3-vendor").val();
    if (s3Vendor) {
      body.captionConfig.storage.vendor = parseInt(s3Vendor);
    }

    const s3Region = $("#s3-region").val();
    if (s3Region) {
      body.captionConfig.storage.region = parseInt(s3Region);
    }

    const s3FileNamePrefix = $("#s3-fileNamePrefix").val();
    if (s3FileNamePrefix) {
      body.captionConfig.storage.fileNamePrefix = [s3FileNamePrefix];
    }
  }

  console.log("Starting transcription with body:", body);

  // Determine URL based on version
  let url;
  if (sttVersion === "7.x") {
    url = `${gatewayAddress}/api/speech-to-text/v1/projects/${options.appid}/join`;
  } else {
    url = `${gatewayAddress}/v1/projects/${options.appid}/rtsc/speech-to-text/tasks?builderToken=${tokenName}`;
  }

  const res = await fetch(url, {
    method: 'POST',
    headers: {
      "Content-Type": "application/json",
      "Authorization": authorization
    },
    body: JSON.stringify(body)
  });

  const responseText = await res.text();
  let responseData;
  try {
    responseData = JSON.parse(responseText);
  } catch (e) {
    responseData = { message: responseText };
  }

  if (!res.ok) {
    if (res.status === 409 && responseData.taskId) {
      taskId = responseData.taskId;
      updateButtonStates('transcribing');
      return { taskId };
    }
    throw new Error(responseData.message || `HTTP error ${res.status}`);
  }

  // Handle different response formats based on version
  if (sttVersion === "7.x") {
    if (!responseData.agent_id) {
      throw new Error("No agent_id received from server");
    }
    taskId = responseData.agent_id;
    // You might want to handle different status codes here
    if (responseData.status !== "RUNNING") {
      throw new Error(`Unexpected status: ${responseData.status}`);
    }
  } else {
    if (!responseData.taskId) {
      throw new Error("No taskId received from server");
    }
    taskId = responseData.taskId;
  }

  updateButtonStates('transcribing');
  return responseData;
}

// Update stopTranscription to handle button states
async function stopTranscription() {
  if (!taskId) return;
  
  // Determine URL and method based on version
  let url;
  let method;
  if (sttVersion === "7.x") {
    url = `${gatewayAddress}/api/speech-to-text/v1/projects/${options.appid}/agents/${taskId}/leave`;
    method = 'POST';
  } else {
    url = `${gatewayAddress}/v1/projects/${options.appid}/rtsc/speech-to-text/tasks/${taskId}?builderToken=${tokenName}`;
    method = 'DELETE';
  }
  
  await fetch(url, {
    method: method,
    headers: {
      "Content-Type": "application/json",
      "Authorization": GetAuthorization()
    }
  });
  
  taskId = null;
  updateButtonStates('joined');
  
  // Clear all transcriptions
  $("[id^=transcription-]").text("");
  $("[id^=translation-]").text("");
}

// Update button state management
function updateButtonStates(state) {
  switch(state) {
    case 'initial':
      $("#join").prop('disabled', false).removeClass('opacity-50 cursor-not-allowed');
      $("#leave").prop('disabled', true).addClass('opacity-50 cursor-not-allowed');
      $("#start-trans").prop('disabled', false).removeClass('opacity-50 cursor-not-allowed');
      $("#stop-trans").prop('disabled', true).addClass('opacity-50 cursor-not-allowed');
      break;
    case 'joined':
      $("#join").prop('disabled', true).addClass('opacity-50 cursor-not-allowed');
      $("#leave").prop('disabled', false).removeClass('opacity-50 cursor-not-allowed');
      $("#start-trans").prop('disabled', false).removeClass('opacity-50 cursor-not-allowed');
      $("#stop-trans").prop('disabled', true).addClass('opacity-50 cursor-not-allowed');
      break;
    case 'transcribing':
      $("#start-trans").prop('disabled', true).addClass('opacity-50 cursor-not-allowed');
      $("#stop-trans").prop('disabled', false).removeClass('opacity-50 cursor-not-allowed');
      break;
  }
}

// Update join handler
$("#join").click(async function() {
  if (!options.appid || !options.channel) {
    showPopup("Please configure connection settings first");
    return;
  }

  try {
    options.uid = await client.join(options.appid, options.channel, null, options.uid || null);
    console.log("Joined with UID:", options.uid);
    
    const [audioTrack, videoTrack] = await AgoraRTC.createMicrophoneAndCameraTracks();
    localTrack = videoTrack;
    localAudioTrack = audioTrack;
    
    await client.publish([audioTrack, videoTrack]);
    
    // Setup local video container with proper translation UI
    const localContainer = $(`
      <div id="video-wrapper-${options.uid}" class="video-wrapper">
        <div class="language-selector">
          <select id="translation-lang-${options.uid}" 
                  class="bg-gray-800 rounded px-2 py-1 text-sm" 
                  onchange="updateTranslationView('${options.uid}')">
          </select>
        </div>
        <div class="video-container">
          <div id="local-player" class="w-full h-full"></div>
          <div class="transcription-overlay">
            <div id="transcription-${options.uid}" class="text-xl mb-2"></div>
            <div id="translation-${options.uid}" class="text-gray-300"></div>
          </div>
        </div>
      </div>
    `);

    // Replace existing local player
    $("#local-player").parent().parent().replaceWith(localContainer);
    videoTrack.play("local-player");
    
    // Initialize language selector for local user
    updateLanguageSelector(options.uid);
    
    updateButtonStates('joined');
    showPopup("Joined channel successfully");
  } catch (error) {
    console.error(error);
    showPopup("Failed to join channel: " + error.message);
  }
});

// Update leave handler
$("#leave").click(async function() {
  try {
    // Clear all timeouts including local user
    overlayTimeouts.forEach((timeout, uid) => {
      clearTimeout(timeout);
    });
    overlayTimeouts.clear();
    
    // Hide all overlays
    $(`.transcription-overlay`).addClass('hidden');
    
    if (localTrack) {
      localTrack.stop();
      localTrack.close();
    }
    if (localAudioTrack) {
      localAudioTrack.stop();
      localAudioTrack.close();
    }
    await client.leave();
    $("#local-player").empty();
    $("#remote-playerlist").empty();
    
    updateButtonStates('initial');
    showPopup("Left channel successfully");
  } catch (error) {
    console.error(error);
    showPopup("Failed to leave channel");
  }
});

// Show popup notification
var popups = 0;

function showPopup(message) {
  const newPopup = popups + 1;
  console.log(`Popup count: ${newPopup}`);
  const y = $(`<div id="popup-${newPopup}" class="popupHidden">${message}</div>`);
  $("#popup-section").append(y);
  const x = document.getElementById(`popup-${newPopup}`);
  x.className = "popupShow";
  const z = popups * 10;
  $(`#popup-${newPopup}`).css("left", `${50 + z}%`);
  popups++;
  setTimeout(function() {
    $(`#popup-${newPopup}`).remove();
    popups--;
  }, 3000);
}

// Update user-unpublished handler to be more thorough
client.on("user-unpublished", function(user) {
  // Clear timeout if exists
  if (overlayTimeouts.has(user.uid)) {
    clearTimeout(overlayTimeouts.get(user.uid));
    overlayTimeouts.delete(user.uid);
  }
  
  // Remove elements
  $(`[id^="video-wrapper-${user.uid}"]`).remove();
  $(`[id^="player-${user.uid}"]`).remove();
});

// Update the start-trans click handler
$("#start-trans").click(async function() {
  try {
    if (!$("#key").val() || !$("#secret").val()) {
      showPopup("Please configure STT settings first");
      document.getElementById('sttModal').showModal();
      return;
    }

    if (!options.appid || !options.channel) {
      showPopup("Please configure connection settings first");
      document.getElementById('connectionModal').showModal();
      return;
    }

    $("#start-trans").prop('disabled', true);
    await startTranscription();
    showPopup("Started transcription");
  } catch (error) {
    console.error(error);
    showPopup(error.message || "Failed to start transcription");
    $("#start-trans").prop('disabled', false);
  }
});

// Update the stop-trans click handler
$("#stop-trans").click(async function() {
  try {
    $("#stop-trans").prop('disabled', true);
    await stopTranscription();
    $("#start-trans").prop('disabled', false);
    showPopup("Stopped transcription");
  } catch (error) {
    console.error(error);
    showPopup("Failed to stop transcription");
    $("#stop-trans").prop('disabled', false);
  }
});

// Add helper functions for transcription display
function addTranscribeItem(uid, text) {
  const timestamp = new Date().toLocaleTimeString();
  const itemId = `transcribe-${uid}-${transcribeIndex}`;
  
  if ($(`#${itemId}`)[0]) {
    $(`#${itemId} .msg`).html(text);
  } else {
    const $item = $(`
      <div class="item" id="${itemId}">
        <span class="timestamp">[${timestamp}]</span>
        <span class="uid">${uid}</span>:
        <span class="msg">${text}</span>
      </div>
    `);
    $("#stt-transcribe .content").prepend($item);
  }
}

function addTranslateItem(uid, text) {
  const timestamp = new Date().toLocaleTimeString();
  const itemId = `translate-${uid}-${translateIndex}`;
  
  if ($(`#${itemId}`)[0]) {
    $(`#${itemId} .msg`).html(text);
  } else {
    const $item = $(`
      <div class="item" id="${itemId}">
        <span class="timestamp">[${timestamp}]</span>
        <span class="uid">${uid}</span>:
        <span class="msg">${text}</span>
      </div>
    `);
    $("#stt-translate .content").append($item);
  }
}

// Update speaking languages input
function addLanguageInput(containerId) {
  const container = document.getElementById(containerId);
  const maxLanguages = sttVersion === "7.x" ? 4 : 2;
  const currentInputs = Array.from(container.querySelectorAll('input')).map(input => input.value);
  if (currentInputs.length >= maxLanguages) {
    showPopup(`Maximum ${maxLanguages} speaking languages allowed for ${sttVersion}`);
    return;
  }
  currentInputs.push("");
  renderSpeakingLanguagesInputs(currentInputs, maxLanguages);
}

function addTargetLanguage(btn) {
  const container = btn.parentElement;
  if (container.children.length >= 6) { // Max 5 target languages + button
    showPopup("Maximum 5 target languages allowed per source");
    return;
  }
  
  const div = document.createElement('div');
  div.className = 'flex gap-2';
  div.innerHTML = `
    <input type="text" class="flex-1 bg-gray-800 rounded p-2" placeholder="Target language">
    <button onclick="this.parentElement.remove()" class="bg-red-600 px-3 rounded">-</button>
  `;
  // Insert before the "Add Target Language" button
  btn.parentNode.insertBefore(div, btn);
}

function addTranslationPair() {
  const container = document.getElementById('translation-pairs');
  const maxPairs = sttVersion === "7.x" ? 4 : 2;
  
  if (container.children.length >= maxPairs) {
    showSTTModalAlert(`Maximum ${maxPairs} source languages allowed for ${sttVersion}`);
    return;
  }
  
  const div = document.createElement('div');
  div.className = 'translation-pair border border-gray-700 p-4 rounded';
  div.innerHTML = `
    <div class="mb-4">
      <div class="flex justify-between items-center mb-2">
        <label class="block">Source Language</label>
        <button onclick="this.closest('.translation-pair').remove(); saveTranslationSettings();" class="text-red-500 text-sm">Remove Pair</button>
      </div>
      <input type="text" class="source-lang w-full bg-gray-800 rounded p-2" placeholder="e.g., en-US">
    </div>
    <div class="target-languages space-y-2">
      <label class="block mb-2">Target Languages</label>
      <button onclick="addTargetLanguage(this)" class="bg-blue-600 px-3 py-2 rounded w-full">Add Target Language</button>
    </div>
  `;
  container.appendChild(div);
  saveTranslationSettings();
}

// Store translation settings
let translationSettings = {
  pairs: []
};

// Function to save translation settings
function saveTranslationSettings() {
  translationSettings.pairs = Array.from(document.querySelectorAll('.translation-pair')).map(pair => ({
    source: pair.querySelector('.source-lang').value,
    targets: Array.from(pair.querySelectorAll('.target-languages input'))
      .map(input => input.value)
      .filter(value => value.trim() !== '')
  })).filter(pair => pair.source && pair.targets.length > 0);

  localStorage.setItem('translationSettings', JSON.stringify(translationSettings));
  updateAllLanguageSelectors();
}

// Function to load translation settings
function loadTranslationSettings() {
  // Load speaking languages
  const savedSTT = JSON.parse(localStorage.getItem('sttSettings') || '{}');
  const maxLanguages = sttVersion === "7.x" ? 4 : 2;
  let languages = ["en-US"];
  if (savedSTT.speakingLanguages) {
    languages = savedSTT.speakingLanguages.slice(0, maxLanguages);
  }
  renderSpeakingLanguagesInputs(languages, maxLanguages);

  // Load translation settings
  const saved = localStorage.getItem('translationSettings');
  const container = document.getElementById('translation-pairs');
  container.innerHTML = ''; // Clear existing

  if (saved) {
    translationSettings = JSON.parse(saved);
    const maxPairs = sttVersion === "7.x" ? 4 : 2;
    const pairs = translationSettings.pairs.slice(0, maxPairs);
    
    pairs.forEach(pair => {
      const div = document.createElement('div');
      div.className = 'translation-pair border border-gray-700 p-4 rounded';
      div.innerHTML = `
        <div class="mb-4">
          <div class="flex justify-between items-center mb-2">
            <label class="block">Source Language</label>
            <button onclick="this.closest('.translation-pair').remove()" class="text-red-500 text-sm">Remove Pair</button>
          </div>
          <input type="text" class="source-lang w-full bg-gray-800 rounded p-2" value="${pair.source}">
        </div>
        <div class="target-languages space-y-2">
          <label class="block mb-2">Target Languages</label>
          ${pair.targets.map(target => `
            <div class="flex gap-2">
              <input type="text" class="flex-1 bg-gray-800 rounded p-2" value="${target}">
              <button onclick="this.parentElement.remove()" class="bg-red-600 px-3 rounded">-</button>
            </div>
          `).join('')}
          <button onclick="addTargetLanguage(this)" class="bg-blue-600 px-3 py-2 rounded w-full">Add Target Language</button>
        </div>
      `;
      container.appendChild(div);
    });
  }

  // Only create empty pair if there are no pairs at all
  if (container.children.length === 0) {
    addTranslationPair();
  }

  updateAllLanguageSelectors();
}

// Function to update all language selectors
function updateAllLanguageSelectors() {
  const selectors = document.querySelectorAll('[id^="translation-lang-"]');
  selectors.forEach(selector => {
    updateLanguageSelector(selector.id.replace('translation-lang-', ''));
  });
}

// Fix updateTranslationView function
function updateTranslationView(uid) {
  const selectedLang = $(`#translation-lang-${uid}`).val();
  localStorage.setItem(`translation-pref-${uid}`, selectedLang);
  $(`#translation-${uid}`).text(''); // Clear current translation
}

// Load settings on page load
document.addEventListener('DOMContentLoaded', loadTranslationSettings);

// Save settings when STT modal is closed
document.getElementById('sttModal').addEventListener('close', saveTranslationSettings);

// Add functions to manage overlay visibility
function showOverlay(uid) {
  // Clear existing timeout if any
  if (overlayTimeouts.has(uid)) {
    clearTimeout(overlayTimeouts.get(uid));
  }
  
  // Show overlay for either local or remote user
  if (uid === options.uid) {
    // Local user
    $(`.video-container .transcription-overlay`).removeClass('hidden');
  } else {
    // Remote user
    $(`#video-wrapper-${uid} .transcription-overlay`).removeClass('hidden');
  }
  
  // Set new timeout to hide overlay
  const timeout = setTimeout(() => hideOverlay(uid), OVERLAY_HIDE_DELAY);
  overlayTimeouts.set(uid, timeout);
}

function hideOverlay(uid) {
  if (uid === options.uid) {
    // Local user
    $(`.video-container .transcription-overlay`).addClass('hidden');
  } else {
    // Remote user
    $(`#video-wrapper-${uid} .transcription-overlay`).addClass('hidden');
  }
  overlayTimeouts.delete(uid);
}

// Add version handling functions
function handleVersionChange() {
  sttVersion = $("#stt-version").val();
  const maxLanguages = sttVersion === "7.x" ? 4 : 2;
  
  // Update max languages display
  $("#max-speaking-languages").text(maxLanguages);
  
  // Get current values
  const container = document.getElementById('speaking-languages');
  const currentInputs = Array.from(container.querySelectorAll('input')).map(input => input.value);
  const languages = currentInputs.slice(0, maxLanguages);
  renderSpeakingLanguagesInputs(languages, maxLanguages);

  // Update translation pairs container
  const pairsContainer = document.getElementById('translation-pairs');
  if (sttVersion === "7.x" && pairsContainer.children.length > 4) {
    while (pairsContainer.children.length > 4) {
      pairsContainer.lastChild.remove();
    }
  }
}

function renderSpeakingLanguagesInputs(languages, maxLanguages) {
  const container = document.getElementById('speaking-languages');
  container.innerHTML = '';
  languages.forEach(lang => {
    const div = document.createElement('div');
    div.className = 'flex gap-2';
    div.innerHTML = `
      <input type="text" class="flex-1 bg-gray-800 rounded p-2" value="${lang}">
      <button onclick="this.parentElement.remove()" class="bg-red-600 px-3 rounded">-</button>
    `;
    container.appendChild(div);
  });
  // Add the + button row if not at max
  if (languages.length < maxLanguages) {
    const addDiv = document.createElement('div');
    addDiv.className = 'flex gap-2';
    addDiv.innerHTML = `
      <button onclick="addLanguageInput('speaking-languages')" class="bg-blue-600 px-3 rounded w-full">+</button>
    `;
    container.appendChild(addDiv);
  }
}

// Show inline alert in STT modal
function showSTTModalAlert(message) {
  const alertDiv = document.getElementById('stt-modal-alert');
  alertDiv.textContent = message;
  alertDiv.classList.remove('hidden');
  // Scroll modal to top so alert is visible
  const sttModal = document.getElementById('sttModal');
  if (sttModal && typeof sttModal.scrollTo === 'function') {
    sttModal.scrollTo({ top: 0, behavior: 'smooth' });
  } else if (sttModal) {
    sttModal.scrollTop = 0;
  }
  setTimeout(() => {
    alertDiv.classList.add('hidden');
  }, 3000);
}
</script>

</body>
</html>